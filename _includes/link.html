{%- comment -%}

  NEVER use inclue_cached with this.

  Always use
    {%include link.html to="/path/to/page/" text="Link Text" %}
  Or
    {%include link.html to="/path/to/page/" fallback="English Link Text" %}

  The page title of the linked page is used unless a link text is specified. Fallback is displayed if the page cannot be found in that language.
{%- endcomment -%}

{%- assign in_lang = true -%}
{%- assign link_page=site.documents | where:"ref", include.to | where: "lang", page.lang | first -%}
{%- unless link_page.url -%}
  {%- assign link_page=site.pages | where:"ref", include.to | where: "lang", page.lang | first -%}
{%- endunless -%}
{%- unless link_page.url -%}
  {%- assign in_lang = false -%}
  {%- assign link_page=site.documents | where:"permalink", include.to | first -%}
{%- endunless -%}
{%- unless link_page.url -%}
  {%- assign in_lang = false -%}
  {%- assign link_page=site.pages | where:"permalink", include.to | first -%}
{%- endunless -%}
{%- if page.lang == 'en' %}{%- assign in_lang = true -%}{% endif -%}

{%- if include.text.en -%}
  {%- assign link_text = include.text[page.lang] -%}
{%- else -%}
  {%- assign link_text = include.text -%}
{%- endif -%}

{%- if link_page.url -%}
  <a lang="{{link_page.lang}}" href="{{link_page.url | relative_url }}"{% if include.aria-current %} aria-current="{{include.aria-current}}"{% endif %}>{% if include.text %}{{ link_text }}{% else %}{{link_page.title}}{% endif %}{%- unless in_lang %} ({% include t.html t="in English"%}){% endunless -%}</a>
{%- else -%}
  <a href="https://www.w3.org/WAI{{include.to}}"{% if include.aria-current %} aria-current="{{include.aria-current}}"{% endif %}>{% if include.text %}{{link_text}}{% else %}{%if include.fallback %}{{include.fallback}}{% endif%}{% endif%}{%- unless in_lang %} ({% include t.html t="in English"%}){% endunless -%}</a>
{%- endif -%}